>[!important]
>ì˜¤ëŠ˜ë‚ ì˜ í”„ë¡œê·¸ë˜ë°ì€ ë” í¬ê³  ì‰¬ìš´ í”„ë¡œê·¸ë¨ì„ ë§Œë“¤ë ¤ëŠ” ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œìì™€
>ë” í¬ê³  ë©ì²­í•œ ë°”ë³´ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ ë…¸ë ¥í•˜ëŠ” ìš°ì£¼ ì‚¬ì´ì˜ ëŒ€ê²°ì´ë‹¤.
>ì§€ê¸ˆê¹Œì§€ëŠ” ìš°ì£¼ê°€ ì´ê¸°ê³  ìˆë‹¤ - ë¦¬ì¹˜ ì¿¡(Rich Cook)

>[!important]
>ëª¨ì˜ ê°ì²´ì— ë¹„ì§€ë‹ˆìŠ¤ ë¡œì§ì„ ì‘ì„±í•˜ì§€ ì•ŠëŠ”ë‹¤
>ëª¨ì˜ ê°ì²´ë¥¼ ì‘ì„± ì‹œ ê°€ì¥ ì¤‘ìš”í•œ ê·œì¹™ì€ ëª¨ì˜ ê°ì²´ê°€ ë¹„ì§€ë‹ˆìŠ¤ ë¡œì§ì„ ê°€ì ¸ì„œëŠ” ì•ˆëœë‹¤ëŠ” ê²ƒì´ë‹¤. 
>ëª¨ì˜ ê°ì²´ëŠ” í…ŒìŠ¤íŠ¸ê°€ ì‹œí‚¤ëŠ” ëŒ€ë¡œë§Œ í•´ì•¼ í•œë‹¤. ë‹¤ì‹œ ë§í•´ ìˆœì „íˆ í…ŒìŠ¤íŠ¸ì— ì˜í•´ì„œë§Œ êµ¬ë™ë˜ëŠ” ê°ì²´ê°€ ëª¨ì˜ ê°ì²´ë‹¤
>ì´ëŸ° íŠ¹ì„±ì€ ëª¨ë“  ë¡œì§ì„ ê°€ì§€ê³  ìˆëŠ” ìŠ¤í…ê³¼ ë°˜ëŒ€ëœë‹¤
>ëª¨ì˜ ê°ì²´ì— ë¹„ì§€ë‹ˆìŠ¤ ë¡œì§ì„ ë„£ì§€ ì•Šìœ¼ë©´ ì¢‹ì€ ì ì´ ë‘ ê°€ì§€ ìˆë‹¤. 
>ì²«ì§¸, ëª¨ì˜ ê°ì²´ë¥¼ ë§Œë“¤ê¸°ê°€ ì‰¬ì›Œì§„ë‹¤. 
>ë‘˜ë•Œ, ëª¨ì˜ ê°ì²´ëŠ” ë¹ˆ ê»ë°ê¸°ì´ë¯€ë¡œ ëª¨ì˜ ê°ì²´ë¥¼ í…ŒìŠ¤íŠ¸í•  í•„ìš”ê°€ ì—†ë‹¤
## 8.1 ëª¨ì˜ ê°ì²´ë€ ë¬´ì—‡ì¸ê°€
- ëª¨ì˜ ê°ì²´
	- **í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì‹¤ì œ ê°ì²´ë¥¼ ëŒ€ì²´í•˜ì—¬ íŠ¹ì • ë™ì‘ì„ ì‹œë®¬ë ˆì´ì…˜í•˜ë„ë¡ ì„¤ê³„ëœ ê°ì²´**
	- ì£¼ë¡œ í…ŒìŠ¤íŠ¸ì—ì„œ ì™¸ë¶€ ì˜ì¡´ì„±ì„ ê²©ë¦¬í•˜ê³ , í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ì½”ë“œì˜ ë™ì‘ì„ ê²€ì¦í•˜ê±°ë‚˜ íŠ¹ì • ì¡°ê±´ì„ ì‹œë®¬ë ˆì´ì…˜í•˜ê¸° ìœ„í•´ ì‚¬ìš©
	- ë¹„ì§€ë‹ˆìŠ¤ ë¡œì§ì˜ ì¼ë¶€ë§Œì„ ë‹¤ë¥¸ ë¶€ë¶„ê³¼ ê²©ë¦¬í•´ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë° ì í•©
	- ë¹„ì§€ë‹ˆìŠ¤ ë¡œì§ì„ ìƒˆë¡œ êµ¬í˜„í•  í•„ìš”ê°€ ì—†ë‹¤. ëª¨ì˜ ê°ì²´ëŠ” í…ŒìŠ¤íŠ¸ê°€ ê°€ì§œë¡œ ë§Œë“  í´ë˜ìŠ¤ì˜ ëª¨ë“  ë¹„ì§€ë‹ˆìŠ¤ ë¡œì§ì„ ì œì–´í•˜ë„ë¡ í•˜ëŠ” ê»ë°ê¸°
- ëª¨ì˜ ê°ì²´ì˜ ì¥ì 
	- ë©”ì„œë“œì— ì§‘ì¤‘í•˜ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤
	- ëª¨ì˜ ê°ì²´ë¥¼ ì‚¬ìš©í•˜ë©´ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ë©”ì„œë“œê°€ ë‹¤ë¥¸ ê°ì²´ë¥¼ í˜¸ì¶œí•´ì„œ ë°œìƒí•˜ëŠ” ë¶€ìˆ˜ íš¨ê³¼ê°€ ìƒê¸¸ ì¼ì´ ì—†ë‹¤
	- ëª¨ì˜ ê°ì²´ëŠ” ì‚¬ì „ì— ì •ì˜ëœ ë™ì‘ì´ ì—†ê³  í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ëª¨ì˜ ê°ì²´ê°€ ìˆ˜í–‰í•  í–‰ë™ì„ ê¸°ëŒ€í•  ìˆ˜ ìˆë‹¤
- ëª¨ì˜ ê°ì²´ë¥¼ ì‚¬ìš©í•œ í…ŒìŠ¤íŠ¸
	- 'ëª¨ì˜ ê°ì²´ ì´ˆê¸°í™” -> ê¸°ëŒ€ ì„¤ì • -> í…ŒìŠ¤íŠ¸ ì‹¤í–‰ -> ë‹¨ì–¸ë¬¸ ê²€ì¦'

## 8.2 ëª¨ì˜ ê°ì²´ë¥¼ í™œìš©í•´ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸í•˜ê¸°
- í…ŒìŠ¤íŠ¸ ìœ ìŠ¤ì¼€ì´ìŠ¤
![[Drawing 2024-11-28 14.41.13.excalidraw]]
- Account í´ë˜ìŠ¤
```Java
public class Account {
    private String accountId;
    private long balance;

    public Account(String accountId, long initialBalance) {
        this.accountId = accountId;
        this.balance = initialBalance;
    }

    public void debit(long amount) {
        this.balance -= amount;
    }

    public void credit(long amount) {
        this.balance += amount;
    }

    public long getBalance() {
        return this.balance;
    }
}
```
- AccountService í´ë˜ìŠ¤
```Java
public class AccountService {
    /**
     * The account manager implementation to use.
     */
    private AccountManager accountManager;

    /**
     * A setter method to set the account manager implementation.
     *
     * @param manager
     */
    public void setAccountManager(AccountManager manager) {
        this.accountManager = manager;
    }

    /**
     * A transfer method which transfers the amount of money
     * from the account with the senderId to the account of
     * beneficiaryId.
     *
     * @param senderId
     * @param beneficiaryId
     * @param amount
     */
    public void transfer(String senderId, String beneficiaryId, long amount) {
        Account sender = accountManager.findAccountForUser(senderId);
        Account beneficiary = accountManager.findAccountForUser(beneficiaryId);

        sender.debit(amount);
        beneficiary.credit(amount);
        this.accountManager.updateAccount(sender);
        this.accountManager.updateAccount(beneficiary);
    }
}
```
- MockAccountManager í´ë˜ìŠ¤
```Java
public class MockAccountManager implements AccountManager {
    /**
     * A Map to hold all the <userId, account> values.
     */
    private Map<String, Account> accounts = new HashMap<String, Account>();

    /**
     * A method to add an account to the manager.
     *
     * @param userId
     * @param account
     */
    public void addAccount(String userId, Account account) { 1ï¸âƒ£
        this.accounts.put(userId, account); 1ï¸âƒ£
    }

    /**
     * A method to find an account for the user with the given ID.
     */
    public Account findAccountForUser(String userId) { 2ï¸âƒ£
        return this.accounts.get(userId); 2ï¸âƒ£
    }

    /**
     * A method to update the given account. Notice that we don't need this method and that's why we leave it with a
     * blank implementation.
     */
    public void updateAccount(Account account) { 3ï¸âƒ£
        // do nothing 3ï¸âƒ£
    }
}
```
	- addAccount ë©”ì„œë“œëŠ” accountsì— userIdì— í‚¤ë¥¼ ê°–ê³  Account ê°ì²´ë¥¼ ê°’ìœ¼ë¡œ ê°–ëŠ” ìŒì„ ì¶”ê°€(1)í•œë‹¤. userIdë³„ë¡œ Account ê°ì²´ë¥¼ ê°€ì§€ê³  ìˆì–´ì•¼ í•˜ë¯€ë¡œ HashMap ì‚¬ìš©
	- findAccountForUser ë©”ì„œë“œëŠ” accountsì—ì„œ userIdë¥¼ ê°€ì§€ê³  Account ê°ì²´ë¥¼ ì¡°íšŒí•œë‹¤(2)
	- updateAccount ë©”ì„œë“œëŠ” í˜„ì¬ ì•„ë¬´ ì‘ì—…ë„ ìˆ˜í–‰í•˜ì§€ ì•Šìœ¼ë©° ê°’ì„ ë°˜í™˜í•˜ì§€ë„ ì•ŠëŠ”ë‹¤(3)
- MockAccountManagerë¥¼ í™œìš©í•´ transfer ë©”ì„œë“œë¥¼ í…ŒìŠ¤íŠ¸í•˜ê¸°
```Java
public class TestAccountService {
    @Test
    public void testTransferOk() { 1ï¸âƒ£
        Account senderAccount = new Account("1", 200); 1ï¸âƒ£
        Account beneficiaryAccount = new Account("2", 100); 1ï¸âƒ£

        MockAccountManager mockAccountManager = new MockAccountManager(); 1ï¸âƒ£
        mockAccountManager.addAccount("1", senderAccount); 1ï¸âƒ£
        mockAccountManager.addAccount("2", beneficiaryAccount); 1ï¸âƒ£

        AccountService accountService = new AccountService(); 1ï¸âƒ£
        accountService.setAccountManager(mockAccountManager); 1ï¸âƒ£

        accountService.transfer("1", "2", 50); 2ï¸âƒ£

        assertEquals(150, senderAccount.getBalance()); 3ï¸âƒ£
        assertEquals(150, beneficiaryAccount.getBalance()); 3ï¸âƒ£
    }
}
```
	- (1) í…ŒìŠ¤íŠ¸ ì„¤ì •í•˜ê¸°
	- (2) í…ŒìŠ¤íŠ¸ ì‹¤í–‰í•˜ê¸°
	- (3) í…ŒìŠ¤íŠ¸ ê²°ê³¼ ê²€ì¦

## 8.3 ëª¨ì˜ ê°ì²´ë¥¼ í™œìš©í•´ ë¦¬íŒ©í„°ë§í•˜ê¸°
- ë¦¬íŒ©í„°ë§ì´ í•„ìš”í•œ ì½”ë“œ
```Java
/**
 * Default account manager implementation before refactoring.
 */
public class DefaultAccountManager1
        implements AccountManager {
    /**
     * Logger instance.
     */
    private static final Log logger = LogFactory.getLog(DefaultAccountManager1.class); 1ï¸âƒ£

    /**
     * Finds an account for user with the given userID.
     *
     * @param
     */
    public Account findAccountForUser(String userId) {
        logger.debug("Getting account for user [" + userId + "]");
        ResourceBundle bundle = PropertyResourceBundle.getBundle("technical"); 2ï¸âƒ£
        String sql = bundle.getString("FIND_ACCOUNT_FOR_USER");

        // Some code logic to load a user account using JDBC
        return null;
    }

    /**
     * Updates the given account.
     *
     * @param
     */
    public void updateAccount(Account account) {
        // Perform database access here
    }
}
```
	- loggerë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ Log ê°ì²´ ìƒì„±(1)
	- ì ì ˆí•œ SQL ê°€ì ¸ì˜¤ê¸°(2)
### 8.3.1 ë¦¬íŒ©í„°ë§ ì˜ˆì œ
- ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±ì„ ìœ„í•´ ë¦¬íŒ©í„°ë§í•œ DefaultAccountManager2 í´ë˜ìŠ¤
```Java
/**
 * Refactored architecture. We now pass the Configuration and
 * Log objects to the constructor and use them for our own logic.
 */
public class DefaultAccountManager2
        implements AccountManager {
    /**
     * Logger instance.
     */
    private Log logger; 1ï¸âƒ£

    /**
     * Configuration to use.
     */
    private Configuration configuration; 1ï¸âƒ£

    /**
     * Constructor with no parameters.
     */
    public DefaultAccountManager2() { 2ï¸âƒ£
        this(LogFactory.getLog(DefaultAccountManager2.class), 2ï¸âƒ£
                new DefaultConfiguration("technical")); 2ï¸âƒ£
    }

    /**
     * Constructor with logger and configration parameters.
     *
     * @param logger
     * @param configuration
     */
    public DefaultAccountManager2(Log logger,
                                  Configuration configuration) {
        this.logger = logger;
        this.configuration = configuration;
    }

    /**
     * Finds an account for user with the given userID.
     *
     * @param
     */
    public Account findAccountForUser(String userId) {
        this.logger.debug("Getting account for user ["
                + userId + "]");
        this.configuration.getSQL("FIND_ACCOUNT_FOR_USER");

        // Some code logic to load a user account using JDBC
        return null;
    }

    /**
     * Updates the given account.
     */
    public void updateAccount(Account account) {
        // Perform database access here
    }
}
```
	- (1)ì—ì„œ PropertyResourceBundle ëŒ€ì‹  Configuration í•„ë“œ ì •ì˜
		- ì½”ë“œ ìœ ì—°ì„± í™•ë³´
	- (2) ì—ì„œ Log, Configurationì„ êµ¬í˜„í•œ ê°ì²´ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ëŠ” ìƒì„±ì ì‚¬ìš©
		- DefaultAccountManager2ì˜ ì¬ì‚¬ìš©ì„± í™•ë³´
### 8.3.2 ë¦¬íŒ©í„°ë§ ì‹œ ê³ ë ¤ ì‚¬í•­
- ì œì–´ì˜ ì—­ì „ì„ í†µí•œ í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±
```Java
public void testFindAccountByUser(){
	MockLog logger = new MockLog(); 1ï¸âƒ£
	MockConfiguration configuration = new MockConfiguration(); 2ï¸âƒ£
	configuration.setSQL("SELECT * [...]"); 2ï¸âƒ£
	DefaultAccountManager2 am = new DefaultAccountManager2(logger, configuration); 3ï¸âƒ£

	Account account = am.findAccountForUser("1234");
	[...]
}
```
	- Log ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” ì•„ë¬´ ì¼ë„ í•˜ì§€ ì•ŠëŠ” logger í•„ë“œë¥¼ ëª¨ì˜í•œë‹¤(1)
	- MockConfiguration ê°ì²´ë¥¼ ìƒì„±í•˜ê³  configuration.setSQL ë©”ì„œë“œë¥¼ í˜¸ì¶œí•  ë•Œ SQL ì¿¼ë¦¬ë¥¼ ë°˜í™˜í•˜ë„ë¡ ì„¤ì •í•œë‹¤(2)
	- Log, Configuration ê°ì²´ë¥¼ ìƒì„±ìì— ì „ë‹¬í•´ í…ŒìŠ¤íŠ¸í•  DefaultAccountManager2 ê°ì²´ë¥¼ ìƒì„±í•œë‹¤(3)

## 8.4 HTTP ì—°ê²° ëª¨ì˜í•˜ê¸°
### 8.4.1 ëª¨ì˜ ê°ì²´ ì •ì˜í•˜ê¸°
![[Pasted image 20241128154710.png]]
- ëŸ°íƒ€ì„ì—ì„œ ëª¨ì˜ ê°ì²´ë¥¼ ë³€ê²½
	- URL í´ë˜ìŠ¤ê°€ final í´ë˜ìŠ¤ì´ë¯€ë¡œ MockURL í´ë˜ìŠ¤ê°€ URL í´ë˜ìŠ¤ë¥¼ ìƒì†í•  ìˆ˜ ì—†ë‹¤

### 8.4.2 ì˜ˆì œ ë©”ì„œë“œ í…ŒìŠ¤íŠ¸í•˜ê¸°
- ì˜ˆì œ ë©”ì„œë“œ
```Java
import java.net.URL;
import java.net.HttpURLConnection;
import java.io.InputStream;
import java.io.IOException;

public class WebClient {
	public String getContent(URL url){
		StringBuffer content = new StringBuffer();
		try {
			HttpURLConnection connection = (HttpURLConnection) url.openConnection(); 1ï¸âƒ£
			connection.setDoInput(true); 1ï¸âƒ£
			InputStream is = connection.getInputStream(); 1ï¸âƒ£
			int count;
			while (-1 != ( count = is.read())){ 2ï¸âƒ£
				content.append(new String(Character.toChars(count))); 2
			}
		} catch (IOException e){ 3ï¸âƒ£
			return null; 3ï¸âƒ£
		}
		return content.toString();
	}
}
```
	- HTTP ì—°ê²°ì„ ë§ºëŠ”ë‹¤(1)
	- HTTP ì—°ê²°ì—ì„œ ê°€ì ¸ì˜¨ ëª¨ë“  ì»¨í…ì¸ ë¥¼ ì½ì–´ ë“¤ì¸ë‹¤(2)
	- ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ nullì„ ë°˜í™˜í•œë‹¤(3)

### 8.4.3 ì²« ë²ˆì§¸ ì‹œë„ : ì‰¬ìš´ ë¦¬íŒ©í„°ë§ ê¸°ë²•
- testGetContentOk í…ŒìŠ¤íŠ¸(ë¦¬íŒ©í„°ë§ ì „)
```Java
public class TestWebClientMock {
	@Test
	public void testGetContentOk() throws Exception {
		MockHttpURLConnection mockConnection = new MockHttpURLConnection();
		mockConnection.setExpectedInputStream(
			new ByteArrayInputStream("It works".getBytes()));
				
		MockURL mockURL = new MockURL();
		mockURL.setupOpenConnection(mockConnection);
		WebClient client = new WebClient();

		String workingContent = client.getContent(mockURL);

		assertEquals("It works", workingContent);
	}

}
```
	- ëª¨ì˜ MockHttpURLConnection ê°ì²´ë¥¼ ë§Œë“¤ê³  ë°˜í™˜í•  ìŠ¤íŠ¸ë¦¼ ê°ì²´ë¥¼ ì„¤ì •(1)
	- ëª¨ì˜ MockURL ê°ì²´ë¥¼ ë§Œë“¤ê³  ë°˜í™˜í•  ëª¨ì˜ ì—°ê²°ì„ ì„¤ì •(2)
	- getContent ë©”ì„œë“œë¥¼ í…ŒìŠ¤íŠ¸í•œë‹¤(3)
	- ê²°ê³¼ê°’ì´ "It works"ê°€ ë§ëŠ”ì§€ ê²€ì¦(4)
- ë©”ì„œë“œ íŒ©í„°ë¦¬
	- ëª¨ì˜í•  í´ë˜ìŠ¤ì— ì¸í„°í˜ì´ìŠ¤ê°€ ì—†ì„ ë•Œ íŠ¹íˆ ìœ ìš©
	- ë¨¼ì € ëŒ€ìƒ í´ë˜ìŠ¤ë¥¼ ìƒì†í•˜ê³ , ì´ë¥¼ ì œì–´í•˜ê¸° ìœ„í•œ ì„¸í„° ë©”ì„œë“œì™€ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë‚´ìš©ì„ ë°˜í™˜í•˜ëŠ” ê²Œí„° ë©”ì„œë“œë¥¼ ì •ì˜
	- ì˜ˆì‹œ
- ìˆ˜ì •í•œ testGetContentOk í…ŒìŠ¤
```Java
public class TestWebClientMock {
    @Test
    public void testGetContentOk()
            throws Exception {
        MockHttpURLConnection mockConnection = new MockHttpURLConnection();
        mockConnection.setExpectedInputStream(new ByteArrayInputStream("It works".getBytes()));

        TestableWebClient client = new TestableWebClient(); 1ï¸âƒ£
        client.setHttpURLConnection(mockConnection); 1ï¸âƒ£

        String result = client.getContent(new URL("http://localhost")); 2ï¸âƒ£

        assertEquals("It works", result);
    }

    /**
     * An inner, private class that extends WebClient and allows us
     * to override the createHttpURLConnection method.
     */
    private class TestableWebClient
            extends WebClient1 {
        /**
         * The connection.
         */
        private HttpURLConnection connection;

        /**
         * Setter method for the HttpURLConnection.
         *
         * @param connection
         */
        public void setHttpURLConnection(HttpURLConnection connection) {
            this.connection = connection;
        }

        /**
         * A method that we overwrite to create the URL connection.
         */
        public HttpURLConnection createHttpURLConnection(URL url)
                throws IOException {
            return this.connection;
        }
    }
}
```
	- createHttpURLConnection ë©”ì„œë“œê°€ ëª¨ì˜ë¡œ ë§Œë“  MockHttpURLConnection ê°ì²´ë¥¼ ë°˜í™˜í•˜ë„ë¡ TestableWebClientë¥¼ ì„¤ì •(1)
	- getContent ë©”ì„œë“œë¥¼ í˜¸ì¶œ(2)
### 8.4.4 ë‘ ë²ˆì§¸ ì‹œë„: í´ë˜ìŠ¤ íŒ©í„°ë¦¬ë¥¼ ì‚¬ìš©í•œ ë¦¬íŒ©í„°ë§
- [[í´ë˜ìŠ¤ íŒ©í„°ë¦¬]](class factory)
- MockConnectinoFactory í´ë˜ìŠ¤
```Java
import java.io.InputStream;

public class MockConnectionFactory implements ConnectionFactory {
	private InputStream inputStream;

	public void setData(InputStream stream){
		this.inputStream = stream;
	}

	public InputStream getData(){
		return inputStream;
	}
}
```
- MockConnectionFactoryë¥¼ ì‚¬ìš©í•´ ë¦¬í™í„°ë§ëœ í…ŒìŠ¤íŠ¸
```Java
import java.io.ByteArrayInputStream;

public class TestWebClient {

	@Test
	public void testGetContentOk() throws Exception {
		MockConnectionFactory mockConnectionFactory = new MockConnectionFactory();
		mockConnectionFactory.setData(new ByteArrayInputStream("It works".getBytes()));
		WebClient2 client = new WebClient2();
		String workingContent = client.getContent()
	}
}
```

## 8.5 ëª¨ì˜ ê°ì²´ë¥¼ íŠ¸ë¡œì´ ëª©ë§ˆë¡œ ì‚¬ìš©í•˜ê¸°
- ëª¨ì˜ ê°ì²´ë¥¼ ê´€ì°°ìë¡œ ì‚¬ìš©í•´ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ê°ì²´ê°€ í˜¸ì¶œí•˜ëŠ” ë©”ì„œë“œë¥¼ ëª¨ë‹ˆí„°ë§ í•  ìˆ˜ ìˆë‹¤
- close ë©”ì„œë“œê°€ ì •í™•íˆ í•œ ë²ˆ í˜¸ì¶œë˜ê¸°ë¥¼ ê¸°ëŒ€í•˜ëŠ” InputStream ëª¨ì˜ ê°ì²´
```Java
public class MockInputStream
        extends InputStream {
    /**
     * Buffer to read in.
     */
    private String buffer;

    /**
     * Current position in the stream.
     */
    private int position = 0;

    /**
     * How many times the close method was called.
     */
    private int closeCount = 0;

    /**
     * Sets the buffer.
     *
     * @param buffer
     */
    public void setBuffer(String buffer) {
        this.buffer = buffer;
    }

    /**
     * Reads from the stream.
     *
     * @return
     */
    public int read() throws IOException {
        if (position == this.buffer.length()) { 1ï¸âƒ£ 
            return -1; 1ï¸âƒ£
        }

        return buffer.charAt(this.position++); 1ï¸âƒ£
    }

    /**
     * Close the stream.
     */
    public void close() throws IOException {
        closeCount++; 2ï¸âƒ£
        super.close();
    }

    /**
     * Verify how many times the close method was called.
     *
     * @throws java.lang.AssertionError
     */
    public void verify() throws java.lang.AssertionError { 3ï¸âƒ£
        if (closeCount != 1) { 3ï¸âƒ£
            throw new AssertionError("close() should " + "have been called once and once only"); 3ï¸âƒ£        }
    }
}
```
	- read ë©”ì„œë“œê°€ ë°˜í™˜í•´ì•¼ í•˜ëŠ” ë‚´ìš©ì„ ëª¨ì˜í–ˆë‹¤(1)
	- close ê°ì²´ê°€ í˜¸ì¶œëœ íšŸìˆ˜ë¥¼ ìƒŒë‹¤(2)
	- ê¸°ëŒ€ê°€ ì¶©ì¡±ë˜ì—ˆëŠ”ì§€ë¥¼ ê²€ì¦í•œë‹¤(3)
	- close ëŠ” í•­ìƒ í•œ ë²ˆë§Œ í˜¸ì¶œë˜ì–´ì•¼ í•œë‹¤
## 8.6 ëª¨ì˜ ê°ì²´ í”„ë ˆì„ì›Œí¬ ì‚¬ìš©í•´ ë³´ê¸°
### 8.6.1 EasyMock
- EasyMockì€ ëª¨ì˜ ê°ì²´ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ìœ ìš©í•œ í´ë˜ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ì˜¤í”ˆ ì†ŒìŠ¤ í”„ë ˆì„ì›Œí¬
- EasyMockì„ ì‚¬ìš©í•´ TEstAccountService í…ŒìŠ¤íŠ¸ë¥¼ ì¬ì‘ì—…í•œ ê²°ê³¼
```Java
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import static org.easymock.EasyMock.createMock; 1ï¸âƒ£
import static org.easymock.EasyMock.replay; 1ï¸âƒ£
import static org.easymock.EasyMock.expect; 1ï¸âƒ£
import static org.easymock.EasyMock.verify; 1ï¸âƒ£
import static org.junit.jupiter.api.Assertions.assertEquals;

public class TestAccountServiceEasyMock {
    private AccountManager mockAccountManager; 2ï¸âƒ£

    @BeforeEach
    public void setUp() {
        mockAccountManager = createMock("mockAccountManager", AccountManager.class); 3ï¸âƒ£
    }

    @Test
    public void testTransferOk() {
        Account senderAccount = new Account("1", 200); 4ï¸âƒ£
        Account beneficiaryAccount = new Account("2", 100); 4ï¸âƒ£

        mockAccountManager.updateAccount(senderAccount); 5ï¸âƒ£
        mockAccountManager.updateAccount(beneficiaryAccount); 5ï¸âƒ£

        expect(mockAccountManager.findAccountForUser("1")).andReturn(senderAccount); 6ï¸âƒ£
        expect(mockAccountManager.findAccountForUser("2")).andReturn(beneficiaryAccount); 6ï¸âƒ£
        replay(mockAccountManager); 7ï¸âƒ£

        AccountService accountService = new AccountService();
        accountService.setAccountManager(mockAccountManager);
        accountService.transfer("1", "2", 50);  8ï¸âƒ£

        assertEquals(150, senderAccount.getBalance()); 9ï¸âƒ£
        assertEquals(150, beneficiaryAccount.getBalance()); 9
    }

    @AfterEach
    public void tearDown() {
        verify(mockAccountManager); ğŸ”Ÿ
    }
}
```
	- EasyMock ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ í•„ìš”í•œ ë©”ì„œë“œë¥¼ ê°€ì ¸ì˜¨ë‹¤(1). (ì •ì ìœ¼ë¡œ ê°€ì ¸ì˜´)
	- ëª¨ì˜í•˜ë ¤ëŠ” ê°ì²´ë¥¼ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ë¡œ ì„ ì–¸(2). EasyMock í”„ë ˆì„ì›Œí¬ëŠ” ì¸í„°í˜ì´ìŠ¤ë§Œ ëª¨ì˜í•  ìˆ˜ ìˆë‹¤
	- createMock ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ ì›í•˜ëŠ” í´ë˜ìŠ¤ì˜ ëª¨ì˜ ê°ì²´ë¥¼ ìƒì„±(3)
	- í…ŒìŠ¤íŠ¸ì— ì‚¬ìš©í•  Account ê°ì²´ ìƒì„±(4)
	- EasyMockì„ ì‚¬ìš©í•˜ëŠ” ë‘ ê°€ì§€ ê¸°ëŒ€ ì„ ì–¸ ë°©ë²•
		- ë©”ì„œë“œ ë°˜í™˜ íƒ€ì…ì´ voidì¸ ê²½ìš° ëª¨ì˜ ê°ì²´ì—ì„œ ê°„ë‹¨í•˜ê²Œ í˜¸ì¶œ(5)
		- ë©”ì„œë“œê°€ ì–´ë–¤ ì¢…ë¥˜ë“  ê°ì²´ë¥¼ ë°˜í™˜í•  ë•Œ EasyMock APIì¸ expectë‚˜ andReturn ë©”ì„œë“œë¥¼ ì‚¬ìš©í•œë‹¤(6)
	- ê¸°ëŒ€ë¥¼ ì„ ì–¸í•œ ë‹¤ìŒ replay ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤. replay ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ëª¨ì˜ ê°ì²´ì˜ í–‰ë™ì„ ê¸°ë¡í•˜ëŠ” ë‹¨ê³„ì—ì„œ ëª¨ì˜ ê°ì²´ì˜ ë™ì‘ì„ í™œì„±í™”í•˜ëŠ” ë‹¨ê³„ë¡œ ë„˜ì–´ê°„ë‹¤. replay ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ì•¼ ëª¨ì˜ ê°ì²´ê°€ ê¸°ëŒ€í•œ ëŒ€ë¡œ ë™ì‘í•œë‹¤(7)
	- ë‘ ê³„ì¢Œ ê°„ ê³„ì¢Œ ì´ì²´ë¥¼ í•˜ê¸° ìœ„í•´ transfer ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤(8)
	- ì˜ˆìƒ ê²°ê³¼ë¥¼ ë‹¨ì–¸í•œë‹¤(9)
	- @Test ë©”ì„œë“œê°€ ì‹¤í–‰ëœ ë‹¤ìŒ ì‹¤í–‰ë˜ëŠ” @AfterEach ë©”ì„œë“œëŠ” ê¸°ëŒ€ì— ëŒ€í•œ ê²€ì¦ì„ ìˆ˜í–‰í•œë‹¤(10)
		- EasyMockì„ ì‚¬ìš©ã…ë§ˆã…•ã„´ ì–´ë–¤ ëª¨ì˜ ê°ì²´ë“  verify ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ ì´ì „ì— ì„ ì–¸í–ˆë˜ ë©”ì„œë“œ í˜¸ì¶œì— ëŒ€í•œ ê¸°ëŒ€ê°€ ì¶©ì¡±ë˜ì—ˆëŠ”ì§€ ê²€ì¦í•  ìˆ˜ ìˆë‹¤
- EasyMockì„ í™œìš©í•´ WebClient í…ŒìŠ¤íŠ¸ë¥¼ ì¬ì‘ì—…í•œ ê²°ê³¼
```Java
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import static org.easymock.EasyMock.expect; 1ï¸âƒ£
import static org.easymock.EasyMock.expectLastCall; 1ï¸âƒ£
import static org.easymock.classextension.EasyMock.createMock; 1ï¸âƒ£
import static org.easymock.classextension.EasyMock.replay;
import static org.easymock.classextension.EasyMock.verify;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNull;

import java.io.IOException;
import java.io.InputStream;

/**
 * Test the WebClient class using the EasyMock library.
 */
public class TestWebClientEasyMock {
    private ConnectionFactory factory; 2ï¸âƒ£
    private InputStream stream; 2ï¸âƒ£

    @BeforeEach
    public void setUp() {
        factory = createMock("factory", ConnectionFactory.class); 3ï¸âƒ£
        stream = createMock("stream", InputStream.class); 3ï¸âƒ£
    }

    @Test
    public void testGetContentOk()
            throws Exception {
        expect(factory.getData()).andReturn(stream);
        expect(stream.read()).andReturn(Integer.valueOf((byte) 'W')); 4ï¸âƒ£
        expect(stream.read()).andReturn(Integer.valueOf((byte) 'o')); 4ï¸âƒ£
        expect(stream.read()).andReturn(Integer.valueOf((byte) 'r')); 4ï¸âƒ£
        expect(stream.read()).andReturn(Integer.valueOf((byte) 'k')); 4ï¸âƒ£
        expect(stream.read()).andReturn(Integer.valueOf((byte) 's')); 4ï¸âƒ£
        expect(stream.read()).andReturn(Integer.valueOf((byte) '!')); 4ï¸âƒ£

        expect(stream.read()).andReturn(-1);
        stream.close(); 5ï¸âƒ£

        replay(factory); 6ï¸âƒ£
        replay(stream); 6ï¸âƒ£

        WebClient2 client = new WebClient2();

        String workingContent = client.getContent(factory); 7ï¸âƒ£

        assertEquals("Works!", workingContent); 8ï¸âƒ£
    }

    @Test
    public void testGetContentInputStreamNull() throws Exception {
        expect(factory.getData()).andReturn(null);

        replay(factory);
        replay(stream);

        WebClient2 client = new WebClient2();

        String workingContent = client.getContent(factory);

        assertNull(workingContent);
    }

    @Test
    public void testGetContentCannotCloseInputStream() throws Exception {
        expect(factory.getData()).andReturn(stream);
        expect(stream.read()).andReturn(-1);
        stream.close(); 9ï¸âƒ£
        expectLastCall().andThrow(new IOException("cannot close")); ğŸ”Ÿ

        replay(factory);
        replay(stream);

        WebClient2 client = new WebClient2();
        String workingContent = client.getContent(factory);

        assertNull(workingContent);
    }

    @AfterEach
    public void tearDown() {
        verify(factory);
        verify(stream);
    }
}
```
	- ë¨¼ì € í•„ìš”í•œ ê°ì²´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²ƒìœ¼ë¡œ ì‹œì‘í•œë‹¤(1). EasyMockì˜ í´ë˜ìŠ¤ í™•ì¥ì„ ì‚¬ìš©í•˜ë¯€ë¡œ org.easymock.EasyMockì´ ì•„ë‹ˆë¼ org.easymock.classextension.EasyMockì„ ê°€ì ¸ì˜¨ë‹¤. í´ë˜ìŠ¤ í™•ì¥ì„ ìœ„í•œ ì •ì  ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ í´ë˜ìŠ¤ì™€ ì¸í„°í˜ì´ìŠ¤ì˜ ëª¨ì˜ ê°ì²´ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤
	- ëª¨ì˜í•˜ë ¤ëŠ” ê°ì²´ë¥¼ ì„ ì–¸í•˜ê³ (2), createMock ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ ì´ˆê¸°í™”í•œë‹¤(3)
	- stream.read() ë¬¸ì¥ì„ ì‹¤í–‰í•  ë•Œì˜ ê¸°ëŒ€ë¥¼ ì •ì˜í•œë‹¤(4). 
	- (5)ì—ì„œëŠ” streamì—ì„œ close ë©”ì„œë“œê°€ í˜¸ì¶œë  ê²ƒì„ ê¸°ëŒ€í•œë‹¤
	- ëª¨ë“  ê¸°ëŒ€ë¥¼ ì„ ì–¸í•œ ë‹¤ìŒ replay ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤(6)
		- replay ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ëª¨ì˜ ê°ì²´ì˜ í–‰ë™ì„ ê¸°ë¡í•˜ëŠ” ë‹¨ê³„ì—ì„œ ëª¨ì˜ ê°ì²´ë¥¼ ì´ìš©í•´ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë‹¨ê³„ë¡œ ë„˜ì–´ê°„ë‹¤
		- replay ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ê¸° ì „ì—ëŠ” ëª¨ì˜ ê°ì²´ê°€ ìˆ˜í–‰í•´ì•¼ í•˜ëŠ” ì‘ì—…ì„ ê¸°ë¡ë§Œ í•  ë¿ ëª¨ì˜ ê°ì²´ë¥¼ í˜¸ì¶œí•˜ë”ë¼ë„ ë™ì‘ì„ ìˆ˜í–‰í•˜ì§€ ì•ŠëŠ”ë‹¤
	- í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ê³ (7), ì˜ˆìƒ ê²°ê³¼ë¥¼ ë‹¨ì–¸í•œë‹¤(8)
	- InputStreamì„ ë‹«ì„ ìˆ˜ ì—†ì„ ë•Œì˜ ì¡°ê±´ì„ ëª¨ì‚¬í•˜ëŠ” ë˜ ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•œë‹¤. streamì˜ close ë©”ì„œë“œë¥¼ í˜¸ì¶œí•  ë•Œì˜ ê¸°ëŒ€ë¥¼ ì •ì˜í•œë‹¤(9)
	- í˜¸ì¶œì´ ë°œìƒí–ˆì„ ê²½ìš° IOExceptionì´ ë°œìƒí•´ì•¼ í•œë‹¤ëŠ” ì„ ì–¸í•œë‹¤(10)

### 8.6.2 JMock
- JMockì„ ì‚¬ìš©í•´ TestAccountService í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜ì •í•œ ê²°ê³¼
```Java
import org.jmock.Expectations; 1ï¸âƒ£
import org.jmock.Mockery; 1ï¸âƒ£
import org.jmock.junit5.JUnit5Mockery; 1ï¸âƒ£
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.RegisterExtension;

import static org.junit.jupiter.api.Assertions.assertEquals;

/**
 * A test-case to test the AccountService class by means of the JMock framework.
 */
public class TestAccountServiceJMock {
    /**
     * The mockery context that we use to create our mocks.
     */
    @RegisterExtension 2ï¸âƒ£
    Mockery context = new JUnit5Mockery(); 2ï¸âƒ£

    /**
     * The mock instance of the AccountManager to use.
     */
    private AccountManager mockAccountManager; 3ï¸âƒ£

    @BeforeEach
    public void setUp() {
        mockAccountManager = context.mock(AccountManager.class); 4ï¸âƒ£
    }

    @Test
    public void testTransferOk() {
        Account senderAccount = new Account("1", 200); 5ï¸âƒ£
        Account beneficiaryAccount = new Account("2", 100); 5ï¸âƒ£

        context.checking(new Expectations() { 6ï¸âƒ£
            {
                oneOf(mockAccountManager).findAccountForUser("1"); 7ï¸âƒ£
                will(returnValue(senderAccount)); 7ï¸âƒ£
                oneOf(mockAccountManager).findAccountForUser("2");
                will(returnValue(beneficiaryAccount));

                oneOf(mockAccountManager).updateAccount(senderAccount);
                oneOf(mockAccountManager).updateAccount(beneficiaryAccount);
            }
        });

        AccountService accountService = new AccountService();
        accountService.setAccountManager(mockAccountManager);
        accountService.transfer("1", "2", 50); 8ï¸âƒ£

        assertEquals(150, senderAccount.getBalance()); 9ï¸âƒ£
        assertEquals(150, beneficiaryAccount.getBalance()); 9ï¸âƒ£
    }
}
```
		- JMock íŒ¨í‚¤ì§€ ë¡œë“œ(1)
		- JUnit5Mockery ì¸ìŠ¤í„´ìŠ¤ í•„ë“œì— @RegisterExtensionì„ ì¶”ê°€í•˜ëŠ” ê²ƒìœ¼ë¡œ í™•ì¥ ë“±ë¡. contextëŠ” ëª¨ì˜ ê°ì²´ë¥¼ ìƒì„±í•˜ê³  ê¸°ëŒ€ë¥¼ ì •ì˜í•˜ëŠ” ë° ì‚¬ìš©í•œë‹¤(2)
		- ëª¨ì˜í•˜ê¸° ìœ„í•œ mockAccountManager ì¸ìŠ¤í„´ìŠ¤ í•„ë“œë¥¼ ì •ì˜(3)
		- @Test ë©”ì„œë“œ ì´ì „ì— ì‹¤í–‰ë˜ëŠ” @BeforeEach ë©”ì„œë“œì—ì„œ contextë¥¼ ì´ìš©í•´ í”„ë¡œê·¸ë˜ë° ë°©ì‹ìœ¼ë¡œ ëª¨ì˜ ê°ì²´ ìƒì„±(4)
		- ê³„ì¢Œ ì´ì²´í•  ê³„ì¢Œ ë‘ ê°œë¥¼ ì„ ì–¸(5)
		- Expectations ê°ì²´ë¥¼ ìƒì„±í•´ ê¸°ëŒ€ë¥¼ ì„ ì–¸(6)
		- ê¸°ëŒ€ë¥¼ ì„ ì–¸í•˜ëŠ”ë°(7), ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë¬¸ë²•
			- invocation-count(mock-object).method(argument-constraints)
			- inSequence(sequence-name);
			- when(state-machine.is(state-name));
			- will(action);
			- then(state-machine.is(new-state-name));
			- ëª¨ë“  ì ˆì— invocation-count(mock-object)ë¥¼ ì œì™¸í•˜ê³  ì„ íƒì ìœ¼ë¡œ ì‘ì„± ê°€ëŠ¥
			- ì´í›„ ë©”ì„œë“œê°€ ê°ì²´ë¥¼ ë°˜í™˜í•˜ë©´ ë°˜í™˜í•  ê°œê²£ë¥¼ will(returnValue()) ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ ì„ ì–¸í•  ìˆ˜ ìˆë‹¤
		- ê³„ì¢Œ ì´ì²´ë¥¼ ì‹œì‘í•œ ë‹¤ìŒ(8), ì˜ˆìƒ ê²°ê³¼ë¥¼ ë‹¨ì–¸í•œë‹¤(9)
### 8.6.3 Mockito
- Mockitoë¥¼ ì‚¬ìš©í•´ TestAccountService í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜ì •í•œ ê²°ê³¼
```Java
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith; 1ï¸âƒ£
import org.mockito.Mock; 1ï¸âƒ£
import org.mockito.Mockito; 1ï¸âƒ£
import org.mockito.junit.jupiter.MockitoExtension; 1ï¸âƒ£

import static org.junit.jupiter.api.Assertions.assertEquals;
@ExtendWith(MockitoExtension.class) 2ï¸âƒ£
public class TestAccountServiceMockito {
    /**
     * The mock instance of the AccountManager to use.
     */
    @Mock 3ï¸âƒ£
    private AccountManager mockAccountManager; 3ï¸âƒ£

    @Test
    public void testTransferOk() {
        Account senderAccount = new Account("1", 200); 4ï¸âƒ£
        Account beneficiaryAccount = new Account("2", 100); 4ï¸âƒ£

        Mockito.lenient().when(mockAccountManager.findAccountForUser("1")).thenReturn(senderAccount); 5ï¸âƒ£
        Mockito.lenient().when(mockAccountManager.findAccountForUser("2")).thenReturn(beneficiaryAccount); 5ï¸âƒ£

        AccountService accountService = new AccountService();
        accountService.setAccountManager(mockAccountManager);
        accountService.transfer("1", "2", 50); 6ï¸âƒ£

		assertEquals(150, senderAccount.getBalance()); 7ï¸âƒ£
        assertEquals(150, beneficiaryAccount.getBalance()); 7ï¸âƒ£
    }
}
```
	- í•„ìš”í•œ íŒ¨í‚¤ì§€ë¥¼ ê°€ì ¸ì˜¨ë‹¤
	- MockitoExtensionì„ ì‚¬ìš©í•´ JUnit 5 í…ŒìŠ¤íŠ¸ë¥¼ í™•ì¥(2)
	- @ExtendWithëŠ” í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ë‚˜ í…ŒìŠ¤íŠ¸ ë©”ì„œë“œì— ëŒ€í•œ í™•ì¥ì„ ë“±ë¡í•˜ëŠ” ë° ì‚¬ìš©(3)
	- ê³„ì¢Œ ë‘ ê°œë¥¼ ì„ ì–¸(4)
	- when ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ ëª¨ì˜ ê°ì²´ê°€ ìˆ˜í–‰í•  ë™ì‘ì„ ê¸°ëŒ€(5)
	- ì¶”ê°€ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ì—ì„œ ëª¨ì˜ ê°ì²´ ë©”ì„œë“œë¥¼ ì—„ê²©í•˜ê²Œ(strict) í˜¸ì¶œí•˜ì§€ ëª»í•˜ë„ë¡ lenient ë©”ì„œë“œë¥¼ ì‚¬ìš©
	- í•œ ê³„ì¢Œì—ì„œ ë‹¤ë¥¸ ê³„ì¢Œë¡œ ê³„ì¢Œ ì´ì œ ì‹œì‘(6)
	- ì˜ˆìƒ ê²°ê³¼ ë‹¨ì–¸(7)

