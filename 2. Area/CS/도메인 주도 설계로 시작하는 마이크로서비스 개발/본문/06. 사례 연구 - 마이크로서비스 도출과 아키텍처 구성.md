## 6.1 요구사항 정의

- 사용자 관리 및 로그인
    - 사용자를 등록한다. 등록 시 사내 HR(Human Resource) 시스템에 의해 검증된다.
    - 특정 사용자는 사서의 역할을 부여받는다.
    - 사용자는 시스템 사용을 위해 로그인하거나 로그아웃할 수 있다.
- 도서관리
    - 사서는 도서분류정보를 등록/수정/삭제한다.
    - 사서는 입고된 도서를 분류하고 등록/수정/삭제한다.
    - 일반적인 도서는 도서공급사에 의해 공급된다.
    - 각 도서는 대출할 수 있는 수량(재고)이 있으며, 대출/반납에 의해 재고가 조정된다
- 도서 대출 및 반납
    - 사용자는 도서를 검색한다.
    - 사용자는 베스트 대출 목록을 조회할 수 있다.
    - 사용자는 재고가 있는 도서를 대출한다(대출 조건은 2주, 1인당 5권 이내다.
    - 반납되지 않고 대출 기간이 지난 도서는 연체된다.
    - 1권이라도 연체되면 사용자는 대출불가 상태가 된다.
    - 사용자는 대출한도서를 반납할 수 있다.
    - 대출한 모든 도서 이력은 기록된다.
    - 대출하거나 반납 시 사용자에게 10포인트가 부여된다.
    - 연체가 있는 있는 사용자는 대출할 수 없다(대출불가상태).
    - 포인트는 연체 1일당 10포인트씩 연체일을 감면하는 데 사용된다.
    - 연체일을 0으로 만듦으로써 대출가능상태가 된다.
- 배송
    - 원격지의 사용자는 배송을 요청할 수 있다.
    - 배송의 상태는 접수/준비/발송/배송완료다.
    - 배송은 외부 배송업체를 이용한다.
- 이메일
    - 주요 업무 변화 시 이메일로 사용자에게 통보한다.

## 6.2 이벤트 스토밍을 통한 마이크로서비스 도출

### 6.2.1 이벤트 스토밍 워크숍

- 사용자 관리 서브도메인
    
    ![[Untitled 81.png]]
    
    - 이벤트 스토밍 순서
        1. 왼쪽에서 오른쪽 방향으로 업무 처리 흐름별로 도메인 이벤트(오렌지색)를 모두 붙인다
        2. 다음으로 이벤트와 대응되는 커맨드(파란색)를 도출해서 이벤트 오른쪽에 붙인다
        3. 액터(작은 노란색)를 통해 도출된 이벤트와 커맨드를 검증하며 커맨드 왼쪽 아래에 붙인다
        4. 이벤트와 연관된 외부 인터페이스(핑크색)를 식별한다
        5. 각 이벤트와 커맨드에 영향을 받는 데이터 요소인 애그리거트(노란색)를 찾느다
        6. 이벤트 발생 시 타 영역의 커맨드를 트리거하는 정책(라일락색)을 도출한다
    - 이벤트 스토밍 결과
        - **[회원정보 등록됨]** 이벤트 발생 → 레거시 시스템인 **[HR 시스템]**과 연계되어 **직원여부 체크 정책** 에서 사원인지 검증 → **[회원등록 승인됨 or 회원등록 거부됨]** 이벤트 발생
        - **[회원정보 수정됨] & [회원 탈퇴됨] 이벤트** 발생 → 반납 처리에 영향을 받는 회원별 **[포인트 적립], [포인트 감소] 이벤트 발생**
        - 로그인 과정에서 **[로그인됨],[로그아웃됨] 이벤트** 발생
        - **[회원], [포인트], [로그인] 애그리거트 식별**
- 도서 관리 서브도메인
    
    ![[Untitled 82.png]]
    
    - **[운영자 등록됨], [도서 분류 등록됨], [도서관 정보 등록됨], [도서제공업체 등록됨] 이벤트 발생 → [도서 입고됨], [도서 분류됨], [도서 정보 등록됨] 순서대로 이벤트 발생**
    - 대출 서브시스템에서 대출/반납 → **[도서 재고 변경됨] 이벤트 발생**
    - 도서 생명주기에 따라 **[도서 정보 폐기됨] 이벤트**가 마지막에 발생
    - **[도서제공시스템] 외부 시스템 식별**
- 대출, 반납 서브도메인
    
    ![[Untitled 83.png]]
    
    - 도서 대출 → **[도서 검색됨] 이벤트 , [도서 대출됨] 이벤트, 먼 곳에 근무하는 경우 [배송 요청됨] 이벤트**
    - 대출된 도서를 반납 요청하는 메일보내는 **[반납 요청됨] 이벤트** 발생 → 대출자가 도서를 반납하면 **[도서 반납됨] 이벤트,** 반납하지 않고 대출 기간이 지나면 **[도서 연체됨] 이벤트** 발생
    - 도서가 연체되면 시스템에 의해 **[대출 정지됨] 이벤트** 발생, 정지 해제가 요청되면 **[정지 해제됨] 이벤트** 발생, 도서 대출 시 대출된 도서를 집계하는 **[최다 대출 도서 집계됨] 이벤트** 발생
    - 개인별 대출, 연체, 반납 내역을 보여주는 개인별 라이브러리를 생성하는 **[개인별 라이브러리 생성됨] 이벤트**
    - 액터
        - 회원, SYS, 대출자, 타이머, 연체자 등
    - 정책
        - 이메일 발송, 포인트 적립, 배송 접수, 도서 재고 증가, 대출 정지 등
    - 애그리거트
        - 대출도서집계정보, 도서검색정보, 대출, 배송요청 정보, 반납, 연체, 대출가능 여부 등
- 배송 서브도메인
    
    ![[Untitled 84.png]]
    
    - 이벤트
        - 배송업체 등록됨, 배송 접수됨, 배송 준비됨, 배송 발송됨, 배송 완료됨
        - 외부 시스템인 **[이메일 시스템]**과 연동
    - 애그리거트
        - 배송업체, 배송접수정보, 배송준비정보, 배송발송정보, 배송완료 정보
- 게시판 서브도메인
    
    ![[Untitled 85.png]]
    
    - 게시판 생성됨, 공지 등록됨, QnA 등록됨 이벤트
    - [게시판], [공지], [QnA] 애그리거트

### 6.2.2 바운디드 컨텍스트 식별

- 사용자 관리 서브도메인의 애그리거트
    - [회원], [포인트], [로그인]
        - [로그인] → 회원의 정보, 회원이 시스템을 사용하는 시점(로그인 상태)에 발생하는 정보
        - [포인트] 등 → 회원의 부가 정보
        - [로그인] & [회원]으로 바운디드 컨텍스트 분리
    - [대출, 반납]의 애그리거트
        - [대출도서집계정보], [도서검색정보], [대출], [배송요청정보], [반납], [연체], [개인별 라이브러리], [대출가능여부] 등
        - **[대출], [반납], [연체] 등의 애그리거트**는 **액터인 [대출자] ⇒ [대출] 컨텍스트로 도출**
        - [도서검색정보], [최대대출도서집계] ⇒ [도서] 바운디드 컨텍스트
        - CQRS 패ㅑ턴을 사용해 **[도서] 컨텍스트** & 합치지 않고 분리해서 조회를 전담하는 도서 검색 기능과 대출도서집계 정보 기능을 모아 **[카탈로그] 컨텍스트 도출**
        - **[카탈로그] 컨텍스트 →** 도서 정보 조회 및 검색 역할
        - **[도서] 컨텍스트 →** 도서가 변경됐을 때 도메인 이벤트에 의해 일관성을 맞춰야함
        - **[도서] 컨텍스트에서 도서 정보 변경 → [카탈로그] 컨텍스트에 이벤트 전달**
        - [대출] 컨텍스트 → 다른 모든 컨텍스트와 관계
            - 도서가 대출됐을 때 **[대출] 컨텍스트 → [카탈로그] 컨텍스트**가 대출된 도서 정보를 집계하도록 **[도서대출됨] 이벤트**를 전달
                - **[도서] 컨텍스트**에서 도서의 재고를 처리하도록 **[도서대출됨] 이벤트**를 전달
                - 도서 반납 시 **[회원]** 컨텍스트에 포인트가 적립되도록 **[도서반납됨] 이벤트** 발행
        - [이메일] 바운디드 컨텍스트도 도출 → 이메일 처리 전담
- **[카탈로그], [대출], [도서], [배송], [회원], [로그인], [게시판], [이메일]의 바운디드 컨텍스트 식별**

### 6.2.3 컨텍스트 다이어그램

- 컨텍스트 매핑 다이어그램
    
    ![[Untitled 86.png]]
    
    - 점선 → 비동기 호출 & 실선 → 동기 호출

### 6.2.4 이벤트 스토밍 결과를 헥사고날 아키텍처로 표현하기

![[Untitled 87.png]]

- 이벤트 스토밍을 통해 식별한 애그리거트 → 헥사고날의 내부 영역인 도메인 모델 후보
- 커맨드 요소 → 외부 영역의 인바운드 어댑터인 API 후보
- 이벤트 → 외부 여영ㄱ의 아웃바운드 어댑터를 통해 전송될 메시지의 대상

## 6.3 외부 아키텍처 정의

- 아키텍처 구성도
    
    ![[Untitled 88.png]]
    
    - 백엔드 마이크로서비스
        - 사용자/로그인, 배송, 대출, 도서, 도서 카탈로그, 게시판, 이메일 등
    - 프론트엔드
        - Vue js 사용
    - API 게이트웨이
        - 로드 밸런싱, 라우팅 역할
        - 라우팅 → Zuul, 로드 밸런싱 → Ribbon
    - 프론트엔트 + 사용자 / 로그인 백엔드 서비스 + API 게이트웨이
        - 하나의 서비스로 통해 구현
    - 서비스 저장소
        - 서비스 저장소는 MariaDB
        - 카탈로그 서비스에는 MongoDB
    - 서비스 통신
        - 동기 통신 - Feign
        - 비동기 통신 - 메시지 큐
    - 메시지 큐
        - 카프카
    - 배포
        - 도커 컨테이너로 쿠버네티스에 배포
    - 로그 중앙화
        - ELK 스택
    - 모니터링
        - Kiali로 모니터링 및 트레이신 수행
    - 형상관리
        - 깃허브
    - 개발 환경 구축
        - JHipster를 사용

## 6.4 내부 아키텍처 정의

### 6.4.1 패키지 구조 및 명명규칙

- 도메인 모델 중심의 마이크로서비스 패키지 명명 규칙
    
    ![[Untitled 89.png]]
    
    - 내부 영역
        - 도메인 모델, 서비스 인터페이스, 서비스 구현체, 리포지터리
    - 외부 영역
        - API 제공, 저장소 및 다른 서비스와 연계할 웹 REST 컨트롤러, 어댑터, DTO로 구성
- 트랜잭션 스크립트 패턴의 마이크로서비스 패키지 명명규칙
    
    ![[Untitled 90.png]]
    
    ![[Untitled 91.png]]
    
